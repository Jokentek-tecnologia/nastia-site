<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NastIA | Entrevista & Agente</title>
  <style>
    :root{
      --bg:#0b0a14;           /* fundo escuro violeta-azulado */
      --panel:#111024;        /* painel */
      --primary:#8B5CF6;      /* roxo NastIA */
      --secondary:#22D3EE;    /* ciano */
      --accent:#34D399;       /* verde */
      --text:#EAEFF7;         /* texto claro */
      --muted:#9aa4b2;        /* texto secundário */
      --border:rgba(139,92,246,.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
      color: var(--text); background: radial-gradient(1200px 800px at 20% 10%, rgba(139,92,246,0.12), transparent 60%),
                              radial-gradient(1000px 600px at 90% 20%, rgba(34,211,238,0.12), transparent 60%),
                              linear-gradient(180deg, #0b0a14 0%, #0b0a14 100%);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }

    .hidden{ display:none !important; }
    #particles-js{ position:fixed; inset:0; z-index:0; }

    .wrap{ position:relative; z-index:1; width:92%; max-width:840px; }
    .card{ background: rgba(17,16,36,0.85); border:1px solid var(--border); border-radius:16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
           padding:24px; display:flex; flex-direction:column; gap:18px; transition:.35s ease opacity; }

    .brand{ display:flex; align-items:center; gap:12px; padding-bottom:10px; border-bottom:1px solid rgba(139,92,246,.25); }
    .brand img{ height:36px; width:auto; }
    .brand h1{ margin:0; font-size:18px; font-weight:600; letter-spacing:.3px; color:var(--secondary); }

    .box{ min-height:120px; background: rgba(139,92,246,.10); border:1px solid rgba(139,92,246,.35); border-radius:12px; padding:18px; display:flex; align-items:center; }
    .box p{ margin:0; font-size:1.05rem; line-height:1.6; white-space:pre-wrap; }

    .row{ display:flex; gap:10px; }
    input[type="text"]{ flex:1; background:#0c0b1c; border:1px solid var(--border); color:var(--text); padding:14px 14px; border-radius:12px; font-size:1rem; }
    input[type="text"]:focus{ outline:none; box-shadow: 0 0 0 3px rgba(139,92,246,.25); }
    button.send{ width:58px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border:none; color:#070611; font-weight:700; font-size:1.2rem; border-radius:12px; cursor:pointer; }
    button.send:disabled{ opacity:.6; cursor:not-allowed; }

    .agent-header{ text-align:center; padding:0 0 12px; border-bottom:1px solid rgba(139,92,246,.25); }
    .agent-header h2{ margin:0; font-size:1.2rem; color:var(--secondary); font-weight:600; }

    #agent-chat-box{ flex:1; max-height:52vh; overflow:auto; padding-right:8px; }
    .agent-message{ background: rgba(34,211,238,.08); border:1px solid rgba(34,211,238,.3); padding:14px; border-radius:10px; margin-bottom:12px; line-height:1.6; }
    .user-question{ background: transparent; color:var(--muted); text-align:right; padding:6px 8px 14px; margin-bottom:6px; font-style:italic; }

    /* Loading (Construindo seu Agente...) */
    .center{ text-align:center; }
    .loader{
      display:inline-block; width:10px; height:10px; border-radius:50%; background:var(--secondary);
      box-shadow: 18px 0 0 0 var(--primary), 36px 0 0 0 var(--accent);
      animation: bounce 1s infinite ease-in-out;
    }
    @keyframes bounce{ 0%,80%,100%{ transform:scale(0) } 40%{ transform:scale(1.0) } }
    .progress-steps{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .step{ height:6px; width:48px; border-radius:6px; background:rgba(255,255,255,.08); overflow:hidden; }
    .step > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width .6s ease; }

    /* Reset */
    .reset-button{ position:fixed; top:12px; right:12px; padding:6px 10px; font-size:12px; border:1px solid rgba(255,255,255,0.35); background:rgba(0,0,0,0.35); color:#fff; border-radius:10px; cursor:pointer; z-index:5; opacity:.7; }
    .reset-button:hover{ opacity:1 }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <button id="reset-btn" class="reset-button" title="Recomeçar do zero">Reset</button>

  <div class="wrap">

    <!-- ENTREVISTA -->
    <section id="questionnaire-container" class="card">
      <div class="brand">
        <img id="nastia-logo" src="logo_nastia.png" alt="Logo NastIA" />
        <h1>NastIA • Entrevista de Onboarding</h1>
      </div>
      <div id="ai-message-box" class="box"><p id="ai-text"></p></div>
      <div class="row">
        <input type="text" id="ai-input" placeholder="Sua resposta..." autocomplete="off" disabled />
        <button id="ai-send" class="send" disabled>›</button>
      </div>
    </section>

    <!-- CONSTRUINDO AGENTE -->
    <section id="building-container" class="card hidden center">
      <div class="brand" style="justify-content:center; border:none; padding-bottom:0">
        <img src="logo_nastia.png" alt="Logo NastIA" />
        <h1>Construindo seu Agente...</h1>
      </div>
      <div style="padding:10px 0 6px;">
        <span class="loader"></span>
      </div>
      <div class="progress-steps">
        <div class="step"><i id="st1"></i></div>
        <div class="step"><i id="st2"></i></div>
        <div class="step"><i id="st3"></i></div>
      </div>
      <p style="margin:14px 0 0; color:var(--muted)">Preparando persona • Carregando conhecimento • Publicando agente</p>
    </section>

    <!-- AGENTE DE TESTE -->
    <section id="agent-container" class="card hidden" style="min-height:420px;">
      <div class="agent-header"><h2>Seu Agente de Teste</h2></div>
      <div id="agent-chat-box">
        <div class="agent-message"><p id="agent-welcome-message"></p></div>
      </div>
      <div class="row">
        <input type="text" id="agent-input" placeholder="Escreva para o agente..." autocomplete="off" />
        <button id="agent-send" class="send">›</button>
      </div>
    </section>

  </div>

  <!-- Partículas -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // === Partículas ===
    if (window.tsParticles) {
      tsParticles.load("particles-js", {
        fpsLimit: 60,
        interactivity: { events: { onHover: { enable: true, mode: "repulse" }, resize: true } },
        particles: {
          color: { value: ["#8B5CF6", "#22D3EE"] },
          links: { color: "#8B5CF6", distance: 140, enable: true, opacity: 0.25, width: 1 },
          move: { enable: true, speed: 1, direction: "none", outModes: { default: "bounce" } },
          number: { value: 60, density: { enable: true, area: 800 } },
          opacity: { value: 0.25 },
          shape: { type: "circle" },
          size: { value: 3, random: true }
        }
      });
    }

    // === DOM ===
    const questionnaireEl = document.getElementById('questionnaire-container');
    const aiTextEl = document.getElementById('ai-text');
    const aiInput = document.getElementById('ai-input');
    const aiSend = document.getElementById('ai-send');

    const buildingEl = document.getElementById('building-container');
    const st1 = document.getElementById('st1');
    const st2 = document.getElementById('st2');
    const st3 = document.getElementById('st3');

    const agentEl = document.getElementById('agent-container');
    const agentWelcome = document.getElementById('agent-welcome-message');
    const agentChatBox = document.getElementById('agent-chat-box');
    const agentInput = document.getElementById('agent-input');
    const agentSend = document.getElementById('agent-send');

    const resetBtn = document.getElementById('reset-btn');

    // === CONFIG ===
    const STORAGE_KEY = 'nastia_state_v3';
    const WEBHOOK_URL = 'https://webhook.oresultador.com.br/webhook/Entrevistador-IA'; // ÚNICO

    // === ESTADO ===
    let userId = localStorage.getItem('nastia_user_id') || ('guest_' + Date.now());
    localStorage.setItem('nastia_user_id', userId);

    let phase = 'diagnostic'; // 'diagnostic' | 'building' | 'agent'
    let lastQuestionFull = null; // pergunta completa exibida (com DICA/Exemplos)
    let lastQuestionLine = null; // apenas a 1ª linha (sem DICA/Exemplos)
    let lastAiText = '';         // última pergunta exibida
    let agentPersonalization = {};
    let agentChat = [];

    // === HELPERS ===
    function typeWriter(text, el, onDone){
      const t = String(text || '');
      el.innerHTML = '';
      let i = 0;
      (function type(){
        if(i < t.length){ el.innerHTML += t.charAt(i++); return setTimeout(type, 12); }
        onDone && onDone();
      })();
    }
    function extractQuestionLine(full){
      if(!full) return '';
      const i = full.indexOf('\nDICA:');
      return (i > -1 ? full.slice(0, i) : full).trim();
    }
    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          userId, phase, lastQuestionFull, lastQuestionLine, lastAiText,
          agent: { personalization: agentPersonalization, chat: agentChat }
        }));
      }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    async function post(body){
      const res = await fetch(WEBHOOK_URL, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    // Payload robusto para “imitar o FIT” sem quebrar a Nastia
    function buildInterviewPayload(userMessage){
      const base = {
        userId,
        // nomes genéricos:
        prompt: userMessage,
        message: userMessage,
        userMessage: userMessage,
        answer: userMessage,
        resposta: userMessage
      };
      if (lastQuestionLine) {
        return {
          ...base,
          // pares “pergunta anterior”:
          lastQuestion: lastQuestionLine,
          perguntaAnterior: lastQuestionLine,
          previous_question: lastQuestionLine,
          // pares “resposta anterior”:
          lastAnswer: userMessage,
          respostaAnterior: userMessage,
          previousAnswer: userMessage
        };
      }
      return base; // primeira interação
    }

    // Leitor de resposta robusto (aceita variações do FIT/NastIA)
    function getNextQuestion(result){
      if (!result) return null;
      return (
        result.proxima_pergunta ||
        result.proximaPergunta ||
        result.next_question ||
        result.pergunta ||
        result.question ||
        null
      );
    }
    function isComplete(result){
      if (!result) return false;
      return !!(
        result.status === 'complete' ||
        result.status === 'BRIEFING_COMPLETE' ||
        result.finished === true ||
        result.done === true ||
        result.no_more_questions === true
      );
    }

    // === TELAS ===
    function switchToBuilding(){
      phase = 'building'; saveState();
      questionnaireEl.classList.add('hidden');
      buildingEl.classList.remove('hidden');
      setTimeout(()=> st1.style.width='100%', 300);
      setTimeout(()=> st2.style.width='100%', 1100);
      setTimeout(()=> st3.style.width='100%', 1900);
      // depois de uma pequena pausa, vai para o agente
      setTimeout(()=> switchToAgent(), 2600);
    }
    function switchToAgent(){
      buildingEl.classList.add('hidden');
      agentEl.classList.remove('hidden');
      typeWriter(agentPersonalization.welcomeMessage || 'Seu agente está pronto! Pode conversar com ele agora.', agentWelcome);
      phase = 'agent'; saveState();
    }

    // === ENTREVISTA ===
    async function handleInterviewSubmit(){
      const text = (aiInput.value || '').trim();
      if(!text) return;
      aiInput.value = '';
      aiInput.disabled = true; aiSend.disabled = true;

      // mostra “Digitando…” mantendo o histórico visual da pergunta anterior
      const snapshot = lastAiText ? lastAiText + '\n\n' : '';
      aiTextEl.textContent = snapshot + 'Digitando…';

      try{
        const payload = buildInterviewPayload(text);
        const result  = await post(payload);

        // FIM DA ENTREVISTA
        if (isComplete(result)) {
          // tentativa de finalização explícita (ignorada se o fluxo não precisar)
          try { await post({ userId, isFinalStep:true, finalizar:true, finish:true, action:'finalize' }); } catch(_){}
          return switchToBuilding();
        }

        // PRÓXIMA PERGUNTA
        const nextQ = getNextQuestion(result);
        if (nextQ) {
          lastAiText = String(nextQ);
          lastQuestionFull = lastAiText;
          lastQuestionLine = extractQuestionLine(lastAiText);
          typeWriter(lastAiText, aiTextEl, () => { aiInput.disabled = false; aiSend.disabled = false; aiInput.focus(); });
          saveState();
          return;
        }

        // FALLBACK (se backend responder de outro jeito)
        const fallback = String(result?.reply || result?.text || 'Vamos continuar.');
        lastAiText = fallback;
        lastQuestionFull = fallback;
        lastQuestionLine = extractQuestionLine(fallback);
        typeWriter(fallback, aiTextEl, () => { aiInput.disabled = false; aiSend.disabled = false; aiInput.focus(); });
        saveState();
      }catch(err){
        console.error(err);
        typeWriter('Desculpe, não consegui processar agora. Tente novamente.', aiTextEl, () => {
          aiInput.disabled = false; aiSend.disabled = false; aiInput.focus();
        });
      }
    }

    // === AGENTE (teste) ===
    function appendAgentBubble(role, text){
      const div = document.createElement('div');
      div.className = role === 'user' ? 'user-question' : 'agent-message';
      const p = document.createElement('p');
      p.textContent = String(text||'');
      div.appendChild(p);
      agentChatBox.appendChild(div);
      agentChatBox.scrollTop = agentChatBox.scrollHeight;
    }
    async function handleAgentSend(){
      const text = (agentInput.value || '').trim();
      if (!text) return;
      agentInput.value='';
      appendAgentBubble('user', text);
      agentChat.push({ role:'user', text }); saveState();

      try{
        const data = await post({ userId, mode:'agent', agentMode:true, message:text, prompt:text });
        const reply = data.reply || data.answer || data.text || data.message || '...';
        appendAgentBubble('agent', reply);
        agentChat.push({ role:'agent', text: reply }); saveState();
      }catch(err){
        console.error(err);
        appendAgentBubble('agent', '⚠️ Não consegui responder agora. Tente novamente.');
        agentChat.push({ role:'agent', text:'⚠️ Não consegui responder agora. Tente novamente.' }); saveState();
      }
    }

    // === EVENTOS ===
    aiSend.addEventListener('click', handleInterviewSubmit);
    aiInput.addEventListener('keyup', e => { if(e.key === 'Enter') handleInterviewSubmit(); });
    agentSend.addEventListener('click', handleAgentSend);
    agentInput.addEventListener('keyup', e => { if(e.key === 'Enter') handleAgentSend(); });
    resetBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ localStorage.removeItem(STORAGE_KEY); localStorage.removeItem('nastia_user_id'); }catch(_){} location.reload(); });

    // === BOOT / RESTORE ===
    (function init(){
      const restored = loadState();
      if (restored) {
        userId = restored.userId || userId;
        phase = restored.phase || phase;
        lastQuestionFull = restored.lastQuestionFull || lastQuestionFull;
        lastQuestionLine = restored.lastQuestionLine || lastQuestionLine;
        lastAiText = restored.lastAiText || lastAiText;
        agentPersonalization = (restored.agent && restored.agent.personalization) || {};
        agentChat = (restored.agent && restored.agent.chat) || [];
      }

      if (phase === 'agent') {
        questionnaireEl.classList.add('hidden');
        buildingEl.classList.add('hidden');
        agentEl.classList.remove('hidden');
        agentWelcome.textContent = agentPersonalization.welcomeMessage || 'Seu agente está pronto!';
        agentChat.forEach(m => appendAgentBubble(m.role, m.text));
        agentInput && agentInput.focus();
        return;
      }
      if (phase === 'building') {
        questionnaireEl.classList.add('hidden');
        buildingEl.classList.remove('hidden');
        return setTimeout(()=> switchToAgent(), 1600);
      }

      // fase diagnóstico (início)
      agentEl.classList.add('hidden');
      buildingEl.classList.add('hidden');
      questionnaireEl.classList.remove('hidden');

      const firstQuestion = lastAiText || 'Olá! Sou a assistente de IA da NastIA. Vamos começar a criar o seu agente?';
      typeWriter(firstQuestion, aiTextEl, () => { aiInput.disabled = false; aiSend.disabled = false; aiInput.focus(); });
      lastAiText = firstQuestion; saveState();
    })();
  });
  </script>
</body>
</html>